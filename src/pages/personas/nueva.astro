---
// src/pages/personas/nueva.astro
import Layout from "../../layouts/Layout.astro";
import { supabase } from "../../lib/supabase";

// Redirigimos si el usuario no está autenticado
const {
    data: { session },
} = await supabase.auth.getSession();
if (!session) {
    return Astro.redirect("/login");
}

// ¡ACTUALIZACIÓN! Obtenemos tanto las escalas como las sedes
const { data: escalas } = await supabase
    .from("escala_de_crecimiento")
    .select("id, nombre_escala")
    .order("id", { ascending: true });

// Obtenemos las sedes del lado del servidor al cargar la página
const { data: sedes, error } = await supabase
    .from("sedes")
    .select("id, nombre_sede");

if (error) {
    console.error("Error al cargar las sedes:", error);
}
console.log("[Página nueva.astro] Sedes recibidas del servidor:", sedes);
---

<Layout title="Registrar Nueva Persona" session={session}>
    <div class="bg-gray-50 p-4 sm:p-8">
    <div class="max-w-4xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-lg">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">
            Registro de Nueva Persona
        </h1>

        <!-- PASO 2: FORMULARIO COMPLETO (inicialmente oculto) -->
        <form
            id="wizard-form"
            method="POST"
            action="/api/personas"
            enctype="multipart/form-data"
        >
            <!-- PASO 1: VERIFICACIÓN DE ID -->
            <div id="step-1">
                <p class="text-gray-600">
                    Para comenzar, por favor introduce el número de
                    identificación.
                </p>
                <div>
                    <label
                        for="numero_id"
                        class="block text-sm font-medium text-gray-700"
                        >Número de ID</label
                    >
                    <input
                        type="text"
                        id="numero_id"
                        name="numero_id"
                        required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"
                    />
                    <div
                        id="id-error-message"
                        class="text-red-600 text-sm mt-1"
                    >
                    </div>
                </div>
                <div class="mt-6">
                    <!-- ¡CAMBIO IMPORTANTE! type="button" para que no envíe el formulario -->
                    <button
                        type="button"
                        id="verify-btn"
                        class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700"
                    >
                        Verificar y Continuar
                    </button>
                </div>
            </div>
            <div
                id="step-2-message"
                class="p-4 bg-green-50 border-l-4 border-green-400 text-green-700"
            >
                <!-- El mensaje se insertará aquí con JavaScript -->
            </div>

            <input type="hidden" name="numero_id" id="form_numero_id" />

            <!-- PASO 2: CAMPOS ADICIONALES (inicialmente oculto) -->
            <div id="step-2" class="hidden space-y-4">
                <!-- Campo oculto para pasar el numero_id verificado -->
                <!-- <input type="hidden" id="verified_numero_id" name="numero_id" /> -->

                <!-- CAMPO PARA LA SEDE (NUEVO) -->
                <div>
                    <label
                        for="sede_id"
                        class="block text-sm font-medium text-gray-700"
                        >Sede de la Persona</label
                    >
                    <select
                        id="sede_id"
                        name="sede_id"
                        required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"
                    >
                        <option value="" disabled selected
                            >-- Seleccione una sede --</option
                        >
                        {
                            sedes &&
                                sedes.map((sede) => (
                                    <option value={sede.id}>
                                        {sede.nombre_sede}
                                    </option>
                                ))
                        }
                    </select>
                </div>
                <!-- tIPO DE ID -->
                <div>
                    <label
                        for="tipo_id"
                        class="block text-sm font-medium text-gray-700"
                        >Tipo de ID</label
                    >
                    <select
                        id="tipo_id"
                        name="tipo_id"
                        required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"
                    >
                        <option value="Cédula de Ciudadanía"
                            >Cédula de Ciudadanía</option
                        >
                        <option value="Tarjeta de Identidad"
                            >Tarjeta de Identidad</option
                        >
                        <option value="Pasaporte">Pasaporte</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                <!-- Fila 2: Nombres y Apellidos -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label
                            for="nombres"
                            class="block text-sm font-medium text-gray-700"
                            >Nombres</label
                        >
                        <input
                            type="text"
                            id="nombres"
                            name="nombres"
                            required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"
                        />
                    </div>
                    <div>
                        <label
                            for="primer_apellido"
                            class="block text-sm font-medium text-gray-700"
                            >Primer Apellido</label
                        >
                        <input
                            type="text"
                            id="primer_apellido"
                            name="primer_apellido"
                            required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"
                        />
                    </div>
                </div>
                <div>
                    <label
                        for="segundo_apellido"
                        class="block text-sm font-medium text-gray-700"
                        >Segundo Apellido (Opcional)</label
                    >
                    <input
                        type="text"
                        id="segundo_apellido"
                        name="segundo_apellido"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"
                    />
                </div>

                <!-- Fila 3: Género y Nacimiento -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label
                            for="genero"
                            class="block text-sm font-medium text-gray-700"
                            >Género</label
                        >
                        <select
                            id="genero"
                            name="genero"
                            required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"
                        >
                            <option value="Masculino">Masculino</option>
                            <option value="Femenino">Femenino</option>
                        </select>
                    </div>
                    <div>
                        <label
                            for="fecha_nacimiento"
                            class="block text-sm font-medium text-gray-700"
                            >Fecha de Nacimiento</label
                        >
                        <input
                            type="date"
                            id="fecha_nacimiento"
                            name="fecha_nacimiento"
                            required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"
                        />
                    </div>
                </div>

                <!-- Fila 4: Contacto -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label
                            for="email"
                            class="block text-sm font-medium text-gray-700"
                            >Email</label
                        >
                        <input
                            type="email"
                            id="email"
                            name="email"
                            required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"
                        />
                    </div>
                    <div>
                        <label
                            for="telefono"
                            class="block text-sm font-medium text-gray-700"
                            >Teléfono</label
                        >
                        <input
                            type="tel"
                            id="telefono"
                            name="telefono"
                            required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"
                        />
                    </div>
                </div>
                <!-- LISTA DE ESCALAS DE CRECIMIENTO (NUEVO) fila 4.1 -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700"
                        >Escalas de Crecimiento Realizadas</label
                    >
                    <div id="escalas-container" class="mt-2 space-y-2">
                        {
                            escalas &&
                                escalas.map((escala) => (
                                    <div class="flex items-center">
                                        <input
                                            id={`escala-${escala.id}`}
                                            name="escalas_seleccionadas"
                                            type="checkbox"
                                            value={escala.id}
                                            class="h-4 w-4 rounded border-gray-300 text-green-600 focus:ring-green-500"
                                        />
                                        <label
                                            for={`escala-${escala.id}`}
                                            class="ml-3 block text-sm text-gray-900"
                                        >
                                            {escala.nombre_escala}
                                        </label>
                                    </div>
                                ))
                        }
                    </div>
                </div>
                <!-- Fila 5: Dirección y Foto -->
                <div>
                    <label
                        for="direccion"
                        class="block text-sm font-medium text-gray-700"
                        >Dirección</label
                    >
                    <input
                        type="text"
                        id="direccion"
                        name="direccion"
                        required
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"
                    />
                </div>
                <!-- FOTO  -->
                <div class="col-span-full mb-4">
                   
                        <label
                            for="foto_upload"
                            class="block text-sm font-medium text-gray-700"
                            >Foto (Opcional)</label
                        >
                        <!-- Contenedor para la previsualización de la imagen -->
                        <div class="mt-2 flex items-center gap-x-3">
                            <input
                            type="file"
                            id="foto_upload"
                            name="foto_upload"
                            accept="image/png, image/jpeg, image/webp"
                            />
                            <img
                                id="foto-preview"
                                src="https://via.placeholder.com/150"
                                alt="VistaFoto"
                                class="w-[80px] h-[80px] rounded-md object-cover mx-auto md:mx-0"
                            />
                        </div>
                    </div>

                    <!-- Botón de envío final -->
                    <div class="pt-4 border-t border-gray-200">
                        <!-- ¡CAMBIO IMPORTANTE! Este SÍ es type="submit" -->
                        <div
                            id="validation-error"
                            class="hidden mb-4 p-3 rounded-md bg-red-50 border border-red-400 text-red-700"
                        >
                        </div>
                        <div class="flex justify-end pt-6 border-t mt-6">
                            <button type="submit" id="submit-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                                Guardar Persona
                            </button>
                        </div>
                    </div>
                
            </div>
        </form>
    </div>
</div>
    <script>
        import { initializePersonaWizard } from "../../scripts/personas/wizard-form.ts";
        initializePersonaWizard();

        const fotoUploadInput = document.getElementById("foto_upload") as HTMLInputElement;
        const fotoPreviewImg = document.getElementById("foto-preview") as HTMLImageElement;

        // Verificamos que ambos elementos existan para evitar errores
        if (fotoUploadInput && fotoPreviewImg) {
            fotoUploadInput.addEventListener("change", (event) => {
                // Obtenemos el archivo seleccionado
                const input = event.target as HTMLInputElement;
                const file = input.files ? input.files[0] : null;

                if (file) {
                    // Si hay un archivo, usamos FileReader para leerlo
                    const reader = new FileReader();

                    reader.onload = (e) => {
                        // Cuando el archivo se ha leído, ponemos su contenido
                        // como el 'src' de nuestra imagen de previsualización.
                        if (e.target && typeof e.target.result === "string") {
                            fotoPreviewImg.src = e.target.result;
                        }
                    };

                    // Le decimos al reader que lea el archivo como una URL de datos
                    reader.readAsDataURL(file);
                } else {
                    // Si el usuario cancela la selección, volvemos a la imagen por defecto
                    fotoPreviewImg.src = "https://via.placeholder.com/150";
                }
            });
        }
    </script>
</Layout>
