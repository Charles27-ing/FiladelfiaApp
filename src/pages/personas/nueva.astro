---
// src/pages/personas/nueva.astro
import Layout from "../../layouts/Layout.astro";
import { supabase } from "../../lib/supabase";

// Redirigimos si el usuario no está autenticado
const {
    data: { session },
} = await supabase.auth.getSession();
if (!session) {
    return Astro.redirect("/login");
}

// ¡ACTUALIZACIÓN! Obtenemos tanto las escalas como las sedes
const { data: escalas } = await supabase
    .from("escala_de_crecimiento")
    .select("id, nombre_escala")
    .order("id", { ascending: true });

// Obtenemos las sedes del lado del servidor al cargar la página
const { data: sedes, error } = await supabase
    .from("sedes")
    .select("id, nombre_sede");

if (error) {
    console.error("Error al cargar las sedes:", error);
}
console.log("[Página nueva.astro] Sedes recibidas del servidor:", sedes);
---

<Layout title="Registrar Nueva Persona">
    <div class="bg-gray-50 p-4 sm:p-8">
        <div class="max-w-4xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-lg">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">
                Registro de Nueva Persona
            </h1>

            <!-- PASO 2: FORMULARIO COMPLETO (inicialmente oculto) -->
            <form
                id="wizard-form"
                method="POST"
                action="/api/personas"
                enctype="multipart/form-data"
            >
                <!-- PASO 1: VERIFICACIÓN DE ID -->
                <div id="step-1">
                    <h2
                        class="text-lg font-semibold text-gray-700 border-b pb-2 mb-4"
                    >
                        Paso 1: Identificación
                    </h2>
                    <div
                        class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end"
                    >
                        <div class="md:col-span-2">
                            <label
                                for="numero_id"
                                class="block mb-1 text-sm font-medium text-gray-700"
                                >Número de Identificación</label
                            >
                            <input
                                type="text"
                                id="numero_id"
                                class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                placeholder="Introduce el ID"
                            />
                        </div>

                        <div>
                            <button
                                type="button"
                                id="verify-btn"
                                class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out"
                            >
                                Verificar y Continuar
                            </button>
                        </div>
                    </div>
                    <div
                        id="id-error-message"
                        class="hidden mt-2 text-sm text-red-600 p-3 bg-red-50 rounded-md"
                    >
                    </div>
                </div>
                <div
                    id="step-2-message"
                    class="p-4 bg-green-50 border-l-4 border-green-400 text-green-700"
                >
                    <!-- El mensaje se insertará aquí con JavaScript -->
                </div>

                <input type="hidden" name="numero_id" id="form_numero_id" />

                <!-- PASO 2: CAMPOS ADICIONALES (inicialmente oculto) -->
                <div id="step-2" class="hidden space-y-4">
                    <!-- Campo oculto para pasar el numero_id verificado -->
                    <!-- <input type="hidden" id="verified_numero_id" name="numero_id" /> -->

                    <!-- CAMPO PARA LA SEDE (NUEVO) -->
                    <div>
                        <label
                            for="sede_id"
                            class="block text-sm font-medium text-gray-700"
                            >Sede de la Persona</label
                        >
                      
                    </div>
                    <!-- tIPO DE ID -->
                    <div>
                        <label
                            for="tipo_id"
                            class="block text-sm font-medium text-gray-700"
                            >Tipo de ID</label
                        >
                        <select
                            id="tipo_id"
                            name="tipo_id"
                            required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"
                        >
                            <option value="Cédula de Ciudadanía"
                                >Cédula de Ciudadanía</option
                            >
                            <option value="Tarjeta de Identidad"
                                >Tarjeta de Identidad</option
                            >
                            <option value="Pasaporte">Pasaporte</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    <!-- Fila 2: Nombres y Apellidos -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label
                                for="nombres"
                                class="block mb-1 text-sm font-medium text-gray-700"
                                >Nombres</label
                            >
                            <input
                                type="text"
                                id="nombres"
                                name="nombres"
                                required
                                class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm
                            placeholder-gray-400
                            focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                placeholder="Ej: Juan Carlos"
                            />
                        </div>
                        <div>
                            <label
                                for="primer_apellido"
                                class="block mb-1 text-sm font-medium text-gray-700"
                                >Primer Apellido</label
                            >
                            <input
                                type="text"
                                id="primer_apellido"
                                name="primer_apellido"
                                required
                                class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                placeholder="Ej: Rodríguez"
                            />
                        </div>
                    </div>
                    <div>
                        <label
                            for="segundo_apellido"
                            class="block mb-1 text-sm font-medium text-gray-700"
                            >Segundo Apellido</label
                        >
                        <input
                            type="text"
                            id="segundo_apellido"
                            name="segundo_apellido"
                            required
                            class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"
                            placeholder="Ej: Rodríguez"
                        />
                    </div>

                    <!-- Fila 3: Género y Nacimiento -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label
                                for="genero"
                                class="block mb-1 text-sm font-medium text-gray-700"
                                >Género</label
                            >
                            <select
                                id="genero"
                                name="genero"
                                required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"
                            >
                                <option value="Masculino">Masculino</option>
                                <option value="Femenino">Femenino</option>
                            </select>
                        </div>
                        <div>
                            <label
                                for="fecha_nacimiento"
                                class="block mb-1 text-sm font-medium text-gray-700"
                                >Fecha de Nacimiento</label
                            >
                            <input
                                type="date"
                                id="fecha_nacimiento"
                                name="fecha_nacimiento"
                                required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"
                            />
                        </div>
                    </div>

                    <!-- Fila 4: Contacto -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label
                                for="email"
                                class="block mb-1 text-sm font-medium text-gray-700"
                                >Email</label
                            >
                            <input
                                type="email"
                                id="email"
                                name="email"
                                required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"
                            />
                        </div>
                        <div>
                            <label
                                for="telefono"
                                class="block mb-1 text-sm font-medium text-gray-700"
                                >Teléfono</label
                            >
                            <input
                                type="tel"
                                id="telefono"
                                name="telefono"
                                required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"
                            />
                        </div>
                    </div>
                    <!-- LISTA DE ESCALAS DE CRECIMIENTO (NUEVO) fila 4.1 
                <div class="mb-4">
                    <label class="block mb-1 text-sm font-medium text-gray-700"  
                        >Escalas de Crecimiento Realizadas</label
                    >
                    <div id="escalas-container" class="mt-2 space-y-2">
                        {
                            escalas &&
                                escalas.map((escala) => (
                                    <div class="flex items-center">
                                        <input
                                            id={`escala-${escala.id}`}
                                            name="escalas_seleccionadas"
                                            type="checkbox"
                                            value={escala.id}
                                            class="h-4 w-4 rounded border-gray-300 text-green-600 focus:ring-green-500"
                                        />
                                        <label
                                            for={`escala-${escala.id}`}
                                            class="ml-3 block text-sm text-gray-900"
                                        >
                                            {escala.nombre_escala}
                                        </label>
                                    </div>
                                ))
                        }
                    </div>
                </div> -->
                    <!-- Sección: Información de la Iglesia -->
                    <fieldset class="border-t pt-6 mt-6">
                        <legend class="text-lg font-semibold text-gray-700 mb-4"
                            >Información de la Iglesia</legend
                        >
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Campo Sede -->
                            <div>
                                <label
                                    for="sede_id"
                                    class="block mb-1 text-sm font-medium text-gray-700"
                                    >Sede</label
                                >
                                <select
                                    id="sede_id"
                                    name="sede_id"
                                    required
                                    class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"
                                >
                                    <!-- Opciones de sedes aquí -->
                                </select>
                            </div>

                            <!-- Campo Escalas de Crecimiento -->
                            <div>
                                <label
                                    class="block mb-1 text-sm font-medium text-gray-700"
                                    >Escalas Realizadas</label
                                >
                                <div
                                    class="mt-2 space-y-2 border p-3 rounded-md max-h-32 overflow-y-auto"
                                >
                                    <!-- Checkboxes de escalas aquí -->
                                </div>
                            </div>
                        </div>
                    </fieldset>

                    <!-- Fila 5: Dirección y Foto -->
                    <div>
                        <label
                            for="direccion"
                            class="block mb-1 text-sm font-medium text-gray-700"
                            >Dirección</label
                        >
                        <input
                            type="text"
                            id="direccion"
                            name="direccion"
                            required
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"
                        />
                    </div>
                    <!-- FOTO  -->
                    <div class="col-span-full mb-4">
                        <label
                            for="foto_upload"
                            class="block mb-1 text-sm font-medium text-gray-700"
                            >Foto (Opcional)</label
                        >
                        <!-- Contenedor para la previsualización de la imagen -->
                        <div class="mt-2 flex items-center gap-x-3">
                            <input
                                type="file"
                                id="foto_upload"
                                name="foto_upload"
                                accept="image/png, image/jpeg, image/webp"
                            />
                            <img
                                id="foto-preview"
                                src="https://via.placeholder.com/150"
                                alt="VistaFoto"
                                class="w-[80px] h-[80px] rounded-md object-cover mx-auto md:mx-0"
                            />
                        </div>
                    </div>

                    <!-- Botón de envío final -->
                    <div class="pt-4 border-t border-gray-200">
                        <!-- ¡CAMBIO IMPORTANTE! Este SÍ es type="submit" -->
                        <div
                            id="validation-error"
                            class="hidden mb-4 p-3 rounded-md bg-red-50 border border-red-400 text-red-700"
                        >
                        </div>
                        <div class="flex justify-end pt-6 border-t mt-6">
                            <button
                                type="submit"
                                id="submit-btn"
                                class="bg-blue-600 text-white font-bold py-2 px-6 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out"
                            >
                                Guardar Persona
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <script>
        import { initializePersonaWizard } from "../../scripts/personas/wizard-form.ts";
        initializePersonaWizard();

        const fotoUploadInput = document.getElementById(
            "foto_upload",
        ) as HTMLInputElement;
        const fotoPreviewImg = document.getElementById(
            "foto-preview",
        ) as HTMLImageElement;

        // Verificamos que ambos elementos existan para evitar errores
        if (fotoUploadInput && fotoPreviewImg) {
            fotoUploadInput.addEventListener("change", (event) => {
                // Obtenemos el archivo seleccionado
                const input = event.target as HTMLInputElement;
                const file = input.files ? input.files[0] : null;

                if (file) {
                    // Si hay un archivo, usamos FileReader para leerlo
                    const reader = new FileReader();

                    reader.onload = (e) => {
                        // Cuando el archivo se ha leído, ponemos su contenido
                        // como el 'src' de nuestra imagen de previsualización.
                        if (e.target && typeof e.target.result === "string") {
                            fotoPreviewImg.src = e.target.result;
                        }
                    };

                    // Le decimos al reader que lea el archivo como una URL de datos
                    reader.readAsDataURL(file);
                } else {
                    // Si el usuario cancela la selección, volvemos a la imagen por defecto
                    fotoPreviewImg.src = "https://via.placeholder.com/150";
                }
            });
        }
    </script>
</Layout>
