---
// src/pages/personas/nueva.astro
import LayoutProtected from "../../layouts/LayoutProtected.astro";
import { supabase } from "../../lib/supabase";
import type { Departamento } from "../../models/persona.model";

// Cargar datos de Colombia (departamentos y municipios)
import colombiaData from "../../data/colombia.json";
const departamentos: Departamento[] = colombiaData.map((dept: any) => ({
    id: dept.id.toString(),
    nombre: dept.departamento,
    ciudades: dept.ciudades.map((ciudad: string, index: number) => ({
        id: `${dept.id}-${index}`,
        nombre: ciudad,
    })),
}));

// Obtener escalas de crecimiento
const { data: escalas } = await supabase
    .from("escala_de_crecimiento")
    .select("id, nombre_escala")
    .order("id", { ascending: true });

// Obtener sedes
const { data: sedes, error } = await supabase
    .from("sedes")
    .select("id, nombre_sede");

// Obtener ministerios
const { data: ministerios } = await supabase
    .from("ministerios")
    .select("id, nombre_minist")
    .order("nombre_minist", { ascending: true });

if (error) {
    console.error("Error al cargar las sedes:", error);
}
console.log("[P√°gina nueva.astro] Sedes recibidas del servidor:", sedes);
console.log("[P√°gina nueva.astro] Escalas recibidas del servidor:", escalas);
console.log("[P√°gina nueva.astro] Ministerios recibidos del servidor:", ministerios);
---

<LayoutProtected title="Registrar Nueva Persona">
    <div class="bg-gray-50 p-4 sm:p-8">
        <div class="max-w-5xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-lg">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">
                Registro de Nueva Persona
            </h1>

            <!-- FORMULARIO COMPLETO -->
            <form
                id="wizard-form"
                method="POST"
                action="/api/personas"
                enctype="multipart/form-data"
                class="space-y-8"
            >
                <!-- PASO 1: VERIFICACI√ìN DE ID -->
                <div
                    id="step-1"
                    class="bg-gradient-to-br from-green-50 to-emerald-100 p-6 rounded-lg border border-green-200"
                >
                    <h2
                        class="text-xl font-semibold text-green-800 border-b border-green-300 pb-2 mb-4"
                    >
                        Paso 1: Verificaci√≥n de Identificaci√≥n
                    </h2>
                    <div
                        class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end"
                    >
                        <div class="md:col-span-2">
                            <label
                                for="numero_id"
                                class="block mb-1 text-sm font-medium text-gray-700"
                            >
                                N√∫mero de Identificaci√≥n
                            </label>
                            <input
                                type="text"
                                id="numero_id"
                                name="numero_id"
                                required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-colors"
                                placeholder="Ingrese el n√∫mero de identificaci√≥n"
                            />
                        </div>
                        <div>
                            <button
                                type="button"
                                id="check-id-btn"
                                class="w-full px-4 py-2 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-md hover:from-green-700 hover:to-emerald-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-all duration-200 shadow-md"
                            >
                                Verificar ID
                            </button>
                        </div>
                    </div>
                    <div id="id-status" class="mt-3 text-sm"></div>
                </div>

                <!-- INFORMACI√ìN PERSONAL -->
                <div
                    id="step-personal"
                    class="bg-gradient-to-br from-blue-50 to-indigo-100 p-6 rounded-lg border border-blue-200"
                >
                    <h2
                        class="text-xl font-semibold text-blue-800 border-b border-blue-300 pb-2 mb-6"
                    >
                        üìã Informaci√≥n Personal B√°sica
                    </h2>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Columna izquierda: Campos de informaci√≥n -->
                        <div class="lg:col-span-2 space-y-4">
                            <!-- Tipo de documento y n√∫mero -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="tipo_id" class="block mb-1 text-sm font-medium text-gray-700">
                                        Tipo de Documento *
                                    </label>
                                    <select
                                        id="tipo_id"
                                        name="tipo_id"
                                        required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    >
                                        <option value="">Seleccionar...</option>
                                        <option value="CC">C√©dula ciudadana</option>
                                        <option value="TI">Tarjeta de identidad</option>
                                        <option value="CE">C√©dula de extranjer√≠a</option>
                                        <option value="PP">Pasaporte</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="primer_nombre" class="block mb-1 text-sm font-medium text-gray-700">
                                        Nombres Completos *
                                    </label>
                                    <input
                                        type="text"
                                        id="primer_nombre"
                                        name="nombres"
                                        required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        placeholder="Nombres"
                                    />
                                </div>
                                <!-- <div>
                                    <label for="numero_documento" class="block mb-1 text-sm font-medium text-gray-700">
                                        N√∫mero de documento *
                                    </label>
                                    <input
                                        type="text"
                                        id="numero_documento"
                                        name="numero_documento"
                                        required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        placeholder="78293058"
                                    />
                                </div> -->
                            </div>

                            <!-- Apellidos -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                             
                                <div>
                                    <label for="primer_apellido" class="block mb-1 text-sm font-medium text-gray-700">
                                        Primer Apellido *
                                    </label>
                                    <input
                                        type="text"
                                        id="primer_apellido"
                                        name="primer_apellido"
                                        required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        placeholder="Primer apellido"
                                    />
                                </div>
                                <div>
                                    <label for="segundo_apellido" class="block mb-1 text-sm font-medium text-gray-700">
                                        Segundo Apellido
                                    </label>
                                    <input
                                        type="text"
                                        id="segundo_apellido"
                                        name="segundo_apellido"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        placeholder="Segundo apellido"
                                    />
                                </div>
                            </div>

                            <!-- G√©nero y Fecha de nacimiento -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="genero" class="block mb-1 text-sm font-medium text-gray-700">
                                        Genero *
                                    </label>
                                    <select
                                        id="genero"
                                        name="genero"
                                        required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    >
                                        <option value="">Seleccionar...</option>
                                        <option value="Masculino">Masculino</option>
                                        <option value="Femenino">Femenino</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="fecha_nacimiento" class="block mb-1 text-sm font-medium text-gray-700">
                                        Fecha de Nacimiento *
                                    </label>
                                    <input
                                        type="date"
                                        id="fecha_nacimiento"
                                        name="fecha_nacimiento"
                                        required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    />
                                </div>
                            </div>

                            <!-- Campo de edad calculada autom√°ticamente -->
                            <div>
                                <label for="edad" class="block mb-1 text-sm font-medium text-gray-700">
                                    Edad (calculada autom√°ticamente)
                                </label>
                                <input
                                    type="number"
                                    id="edad"
                                    name="edad"
                                    readonly
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100 cursor-not-allowed"
                                    placeholder="Se calcular√° autom√°ticamente"
                                />
                            </div>

                            <!-- Estado Civil y Tel√©fono -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="estado_civil" class="block mb-1 text-sm font-medium text-gray-700">
                                        Estado Civil *
                                    </label>
                                    <select
                                        id="estado_civil"
                                        name="estado_civil"
                                        required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    >
                                        <option value="">Seleccionar...</option>
                                        <option value="SOLTERO(A)">Soltero(a)</option>
                                        <option value="CASADO(A)">Casado(a)</option>
                                        <option value="UNION-LIBRE">Uni√≥n Libre</option>
                                        <option value="VIUDO(A)">Viudo(a)</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="telefono" class="block mb-1 text-sm font-medium text-gray-700">
                                        Tel√©fono *
                                    </label>
                                    <input
                                        type="tel"
                                        id="telefono"
                                        name="telefono"
                                        required
                                        pattern="[0-9]{7,10}"
                                        title="Ingrese solo n√∫meros (7 a 10 d√≠gitos)"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        placeholder="3001234567"
                                    />
                                </div>
                            </div>

                            <!-- Email -->
                            <div>
                                <label for="email" class="block mb-1 text-sm font-medium text-gray-700">
                                    Correo Electr√≥nico /Opcional
                                </label>
                                <input
                                    type="email"
                                    id="email"
                                    name="email"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="correo@ejemplo.com"
                                />
                            </div>

                            <!-- Ubicaci√≥n -->
                            <div class="space-y-4">
                                <h3 class="text-lg font-medium text-gray-800">Ubicaci√≥n</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <!-- Departamento -->
                                    <div>
                                        <label for="departamento" class="block mb-1 text-sm font-medium text-gray-700">
                                            Departamento *
                                        </label>
                                        <select
                                            id="departamento"
                                            name="departamento"
                                            required
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        >
                                            <option value="">Seleccione departamento...</option>
                                            {departamentos.map((dept) => (
                                                <option value={dept.nombre}>{dept.nombre}</option>
                                            ))}
                                        </select>
                                    </div>

                                    <!-- Municipio -->
                                    <div>
                                        <label for="municipio" class="block mb-1 text-sm font-medium text-gray-700">
                                            Municipio *
                                        </label>
                                        <select
                                            id="municipio"
                                            name="municipio"
                                            required
                                            disabled
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100"
                                        >
                                            <option value="">Seleccione municipio...</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Direcci√≥n -->
                                <div>
                                    <label for="direccion" class="block mb-1 text-sm font-medium text-gray-700">
                                        Direcci√≥n/Barrio *
                                    </label>
                                    <input
                                        type="text"
                                        id="direccion"
                                        name="direccion"
                                        required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                        placeholder="Direcci√≥n completa o barrio"
                                    />
                                </div>
                            </div>
                        </div>

                        <!-- Columna derecha: Foto -->
                        <div class="lg:col-span-1">
                            <div class="bg-gray-100 rounded-lg p-4 h-full flex flex-col items-center justify-center min-h-[400px]">
                                <!-- Vista previa de la imagen -->
                                <div id="image-preview-container" class="w-40 h-40 bg-gray-300 rounded-full flex items-center justify-center mb-4 overflow-hidden">
                                    <svg id="default-avatar" class="w-20 h-20 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                    </svg>
                                    <img id="image-preview" src="" alt="Vista previa" class="w-full h-full object-cover hidden">
                                </div>
                                
                                <!-- Opciones de carga de foto -->
                                <div class="w-full space-y-3">
                                    <!-- Cargar desde dispositivo -->
                                    <div>
                                        <label for="foto_archivo" class="block mb-2 text-sm font-medium text-gray-700 text-center">
                                            Subir desde dispositivo
                                        </label>
                                        <input
                                            type="file"
                                            id="foto_archivo"
                                            name="foto"
                                            accept="image/*"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                                        />
                                        <p class="mt-1 text-xs text-gray-500 text-center">
                                            JPG, PNG (m√°x. 5MB)
                                        </p>
                                    </div>
                                    
                                    <!-- O ingresar URL -->
                                    <div class="text-center text-sm text-gray-500">
                                        <span>o</span>
                                    </div>
                                    
                                    <div>
                                        <label for="url_foto" class="block mb-2 text-sm font-medium text-gray-700 text-center">
                                            URL de imagen
                                        </label>
                                        <input
                                            type="url"
                                            id="url_foto"
                                            name="url_foto"
                                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                                            placeholder="https://ejemplo.com/imagen.jpg"
                                        />
                                    </div>
                                    
                                    <!-- Bot√≥n para quitar imagen -->
                                    <button
                                        type="button"
                                        id="remove-image"
                                        class="w-full px-3 py-2 bg-red-100 text-red-700 rounded-md hover:bg-red-200 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm hidden"
                                    >
                                        Quitar imagen
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- INFORMACI√ìN DE LA IGLESIA -->
                <div class="bg-gradient-to-br from-green-50 to-emerald-100 p-6 rounded-lg border border-green-200">
                    <h2 class="text-xl font-semibold text-green-800 border-b border-green-300 pb-2 mb-6">
                        ‚õ™ Informaci√≥n de la Iglesia
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Sede -->
                        <div>
                            <label for="sede" class="block mb-1 text-sm font-medium text-gray-700">
                                Sede *
                            </label>
                            <select
                                id="sede"
                                name="sede"
                                required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"
                            >
                                <option value="">Seleccione sede...</option>
                                {sedes && sedes.map((sede) => (
                                    <option value={sede.id}>{sede.nombre_sede}</option>
                                ))}
                            </select>
                        </div>
                        
                        <!-- Bautizado -->
                        <div>
                            <label class="block mb-2 text-sm font-medium text-gray-700">
                                ¬øEst√° Bautizado? *
                            </label>
                            <div class="flex items-center space-x-4">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="bautizado" value="true" class="form-radio text-green-600" required />
                                    <span class="ml-2 text-gray-700">S√≠</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="bautizado" value="false" class="form-radio text-red-600" required />
                                    <span class="ml-2 text-gray-700">No</span>
                                </label>
                            </div>
                        </div>
                        <!-- Escala de Crecimiento -->
                        <div>
                            <label for="escala_crecimiento" class="block mb-1 text-sm font-medium text-gray-700">
                                Escala de Crecimiento *
                            </label>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 max-h-48 overflow-y-auto border border-gray-200 rounded-md p-3">
                                {escalas  && escalas.map((escalas) => (
                                    <label class="inline-flex items-center">
                                        <input
                                            type="checkbox"
                                            name="escalas"
                                            value={escalas.id}
                                            class="form-checkbox text-green-600"
                                        />
                                        <span class="ml-2 text-gray-700 text-sm">{escalas.nombre_escala}</span>
                                    </label>
                                ))}
                            </div>
                            
                        
                        </div>

                        <div>
                            <label for="escala_crecimiento" class="block mb-1 text-sm font-medium text-gray-700">
                                Minister *
                            </label>
                            <div class="grid grid-cols-1 md:grid-cols-2 border-red-500 lg:grid-cols-3 gap-2 max-h-48 overflow-y-auto border border-gray-200 rounded-md p-3">
                                {ministerios  && ministerios.map((ministerios) => (
                                    <label class="inline-flex items-center">
                                        <input
                                            type="checkbox"
                                            name="escalas"
                                            value={ministerios.id}
                                            class="form-checkbox text-green-600"
                                        />
                                        <span class="ml-2 text-blue-600 text-sm">{ministerios.nombre_minist}</span>
                                    </label>
                                ))}
                            </div>
                        
                        </div>
                        <!-- Ministerios -->
                        <div class="md:col-span-2">
                            <label class="block mb-2 text-sm font-medium text-gray-700">
                                Ministerios (puede seleccionar varios)
                            </label>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 max-h-48 overflow-y-auto border border-gray-200 rounded-md p-3">
                                {ministerios && ministerios.map((ministerio) => (
                                    <label class="inline-flex items-center">
                                        <input
                                            type="checkbox"
                                            name="ministerios"
                                            value={ministerio.id}
                                            class="form-checkbox text-green-600"
                                        />
                                        <span class="ml-2 text-gray-700 text-sm">{ministerio.nombre_minist}</span>
                                    </label>
                                ))}
                                
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bot√≥n de env√≠o -->
                <div class="flex justify-center">
                    <button
                        type="submit"
                        id="submit-btn"
                        class="inline-flex items-center px-6 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
                        disabled
                    >
                        <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Registrar Persona
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts para funcionalidad del formulario -->
    <script define:vars={{ departamentos }} is:inline>
        document.addEventListener('DOMContentLoaded', function() {
            // Variables del DOM
            const checkIdBtn = document.getElementById('check-id-btn');
            const numeroIdInput = document.getElementById('numero_id');
            const idStatus = document.getElementById('id-status');
            const fechaNacimientoInput = document.getElementById('fecha_nacimiento');
            const edadInput = document.getElementById('edad');
            const submitBtn = document.getElementById('submit-btn');
            const telefonoInput = document.getElementById('telefono');
            const departamentoSelect = document.getElementById('departamento');
            const municipioSelect = document.getElementById('municipio');
            const fotoArchivoInput = document.getElementById('foto_archivo');
            const urlFotoInput = document.getElementById('url_foto');
            const imagePreview = document.getElementById('image-preview');
            const defaultAvatar = document.getElementById('default-avatar');
            const removeImageBtn = document.getElementById('remove-image');

            let idVerified = false;

            // Funci√≥n para calcular la edad
            function calcularEdad() {
                const fechaNacimiento = fechaNacimientoInput.value;
                if (fechaNacimiento) {
                    const dob = new Date(fechaNacimiento);
                    const today = new Date();
                    let age = today.getFullYear() - dob.getFullYear();
                    const m = today.getMonth() - dob.getMonth();
                    if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
                        age--;
                    }
                    edadInput.value = age.toString();
                    console.log('Edad calculada:', age);
                } else {
                    edadInput.value = "";
                }
            }

            // Event listener para calcular edad al cambiar la fecha de nacimiento
            if (fechaNacimientoInput) {
                fechaNacimientoInput.addEventListener("change", calcularEdad);
            }

            // Validaci√≥n de tel√©fono - solo n√∫meros
            if (telefonoInput) {
                telefonoInput.addEventListener("input", function(event) {
                    // Eliminar cualquier caracter que no sea un d√≠gito
                    this.value = this.value.replace(/[^0-9]/g, "");
                    
                    // Opcional: Limitar la longitud si es necesario
                    if (this.value.length > 10) {
                        this.value = this.value.slice(0, 10);
                    }
                });
            }

            // Funci√≥n para verificar ID
            checkIdBtn.addEventListener('click', async function() {
                const numeroId = numeroIdInput.value.trim();
                
                if (!numeroId) {
                    showIdStatus('‚ö† Por favor ingrese un n√∫mero de identificaci√≥n', 'error');
                    return;
                }

                try {
                    showIdStatus('üîç Verificando...', 'loading');
                    
                    const response = await fetch('/api/id-checker', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ numero_id: numeroId }),
                    });

                    const result = await response.json();

                    if (result.exists) {
                        showIdStatus('Este n√∫mero de identificaci√≥n ya est√° registrado. Por favor, use uno diferente.', 'error');
                        idVerified = false;
                        submitBtn.disabled = true;
                    } else {
                        showIdStatus('‚úÖ ID disponible para registro', 'success');
                        idVerified = true;
                        submitBtn.disabled = false;
                    }
                } catch (error) {
                    console.error('Error al verificar ID:', error);
                    showIdStatus('Error al verificar el ID. Intente nuevamente.', 'error');
                    idVerified = false;
                    submitBtn.disabled = true;
                }
            });

            // Funci√≥n para mostrar estado del ID
            function showIdStatus(message, type) {
                let className = "";
                switch(type) {
                    case "success":
                        className = "text-green-600";
                        break;
                    case "error":
                        className = "text-red-600";
                        break;
                    case "loading":
                        className = "text-blue-600";
                        break;
                    default:
                        className = "text-gray-600";
                }
                
                idStatus.innerHTML = `<span class="${className}">${message}</span>`;
            }

            // Manejo de departamentos y municipios
            if (departamentoSelect && municipioSelect) {
                departamentoSelect.addEventListener('change', function() {
                    const selectedDept = this.value;
                    municipioSelect.innerHTML = '<option value="">Seleccione municipio...</option>';
                    municipioSelect.disabled = true;

                    if (selectedDept) {
                        const dept = departamentos.find(d => d.nombre === selectedDept);
                        if (dept && dept.ciudades) {
                            dept.ciudades.forEach(ciudad => {
                                const option = document.createElement('option');
                                option.value = ciudad.nombre;
                                option.textContent = ciudad.nombre;
                                municipioSelect.appendChild(option);
                            });
                            municipioSelect.disabled = false;
                        }
                    }
                });
            }

            // Funci√≥n para mostrar previsualizaci√≥n de imagen
            function showImagePreview(src) {
                imagePreview.src = src;
                imagePreview.classList.remove('hidden');
                defaultAvatar.classList.add('hidden');
                removeImageBtn.classList.remove('hidden');
            }

            // Funci√≥n para ocultar previsualizaci√≥n de imagen
            function hideImagePreview() {
                imagePreview.src = '';
                imagePreview.classList.add('hidden');
                defaultAvatar.classList.remove('hidden');
                removeImageBtn.classList.add('hidden');
            }

            // Manejo de archivo de foto
            if (fotoArchivoInput) {
                fotoArchivoInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        // Validar tama√±o (5MB m√°ximo)
                        if (file.size > 5 * 1024 * 1024) {
                            alert('El archivo es demasiado grande. El tama√±o m√°ximo es 5MB.');
                            fotoArchivoInput.value = '';
                            return;
                        }

                        // Validar tipo de archivo
                        if (!file.type.startsWith('image/')) {
                            alert('Por favor seleccione un archivo de imagen v√°lido.');
                            fotoArchivoInput.value = '';
                            return;
                        }

                        // Mostrar previsualizaci√≥n
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            showImagePreview(e.target.result);
                            // Limpiar URL si se selecciona archivo
                            urlFotoInput.value = '';
                        };
                        reader.readAsDataURL(file);
                    } else {
                        hideImagePreview();
                    }
                });
            }

            // Manejo de URL de foto
            if (urlFotoInput) {
                urlFotoInput.addEventListener('input', function() {
                    const url = this.value.trim();
                    if (url) {
                        showImagePreview(url);
                        // Limpiar archivo si se ingresa URL
                        fotoArchivoInput.value = '';
                    } else {
                        hideImagePreview();
                    }
                });
            }

            // Bot√≥n para quitar imagen
            if (removeImageBtn) {
                removeImageBtn.addEventListener('click', function() {
                    hideImagePreview();
                    fotoArchivoInput.value = '';
                    urlFotoInput.value = '';
                });
            }

            // Validaci√≥n del formulario
            const form = document.getElementById('wizard-form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    if (!idVerified) {
                        e.preventDefault();
                        alert('Por favor, verifique el n√∫mero de identificaci√≥n antes de continuar.');
                        return false;
                    }
                    
                    console.log('Enviando formulario...');
                });
            }
        });
    </script>
</LayoutProtected>

