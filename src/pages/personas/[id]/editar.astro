---
// src/pages/personas/[id]/editar.astro - Página de edición de persona
import LayoutProtected from "@/layouts/LayoutProtected.astro";
import { supabase } from "@/lib/supabase";

// Obtener el ID de la persona desde la URL
const { id } = Astro.params;

if (!id) {
  return Astro.redirect('/personas?error=' + encodeURIComponent('ID de persona no válido'));
}

// Definir interfaces
interface Sede {
  id: string;
  nombre_sede: string;
  codigo: string;
}

interface Escala {
  id: string;
  nombre_escala: string;
}

interface Persona {
  id: string;
  nombres: string;
  primer_apellido: string;
  segundo_apellido: string;
  numero_id: string;
  tipo_id: string;
  email: string;
  telefono: string;
  direccion: string;
  genero: string;
  fecha_nacimiento: string;
  edad: number;
  url_foto: string | null;
  sedes: Sede | null;
  persona_escala: { escala_de_crecimiento: Escala }[];
}

// Consultar los datos de la persona específica
const { data: personaData, error } = await supabase
  .from("persona")
  .select(`
    id,
    nombres,
    primer_apellido,
    segundo_apellido,
    numero_id,
    tipo_id,
    email,
    telefono,
    direccion,
    genero,
    fecha_nacimiento,
    edad,
    url_foto,
    sedes(id, nombre_sede, codigo),
    persona_escala(
      escala_de_crecimiento(id, nombre_escala)
    )
  `)
  .eq('id', id)
  .single();

if (error || !personaData) {
  console.error("Error al cargar persona:", error);
  return Astro.redirect('/personas?error=' + encodeURIComponent('Persona no encontrada'));
}

const persona = personaData as Persona;

// Obtener todas las sedes para el select
const { data: sedesData } = await supabase
  .from("sedes")
  .select("id, nombre_sede")
  .order("nombre_sede");

const sedes = sedesData || [];

// Obtener todas las escalas para el select
const { data: escalasData } = await supabase
  .from("escala_de_crecimiento")
  .select("id, nombre_escala")
  .order("nombre_escala");

const escalas = escalasData || [];

// Formatear fecha para input date
const fechaNacimientoFormatted = persona.fecha_nacimiento 
  ? new Date(persona.fecha_nacimiento).toISOString().split('T')[0]
  : '';
---

<LayoutProtected title={`Editar - ${persona.nombres} ${persona.primer_apellido}`}>
  <!-- ====================================================== -->
  <!-- HEADER CON NAVEGACIÓN -->
  <!-- ====================================================== -->
  <div class="mb-6">
    <nav class="flex" aria-label="Breadcrumb">
      <ol class="inline-flex items-center space-x-1 md:space-x-3">
        <li class="inline-flex items-center">
          <a href="/personas" class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-green-600">
            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
            </svg>
            Directorio de Personas
          </a>
        </li>
        <li>
          <div class="flex items-center">
            <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
            </svg>
            <a href={`/personas/${persona.id}`} class="ml-1 text-sm font-medium text-gray-700 hover:text-green-600 md:ml-2">
              {persona.nombres} {persona.primer_apellido}
            </a>
          </div>
        </li>
        <li>
          <div class="flex items-center">
            <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
            </svg>
            <span class="ml-1 text-sm font-medium text-gray-500 md:ml-2">Editar</span>
          </div>
        </li>
      </ol>
    </nav>
  </div>

  <!-- ====================================================== -->
  <!-- FORMULARIO DE EDICIÓN -->
  <!-- ====================================================== -->
  <div class="bg-white shadow-lg rounded-lg overflow-hidden">
    <div class="bg-gradient-to-r from-blue-500 to-blue-600 px-6 py-4">
      <h1 class="text-2xl font-bold text-white">
        Editar Persona: {persona.nombres} {persona.primer_apellido}
      </h1>
    </div>

    <form action={`/api/personas/${persona.id}/update`} method="POST" class="p-6">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Información Personal -->
        <div class="space-y-4">
          <h2 class="text-lg font-semibold text-gray-900 border-b border-gray-200 pb-2">
            Información Personal
          </h2>

          <div>
            <label for="nombres" class="block text-sm font-medium text-gray-700 mb-1">
              Nombres *
            </label>
            <input
              type="text"
              id="nombres"
              name="nombres"
              value={persona.nombres}
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>

          <div>
            <label for="primer_apellido" class="block text-sm font-medium text-gray-700 mb-1">
              Primer Apellido *
            </label>
            <input
              type="text"
              id="primer_apellido"
              name="primer_apellido"
              value={persona.primer_apellido}
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>

          <div>
            <label for="segundo_apellido" class="block text-sm font-medium text-gray-700 mb-1">
              Segundo Apellido
            </label>
            <input
              type="text"
              id="segundo_apellido"
              name="segundo_apellido"
              value={persona.segundo_apellido || ''}
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label for="tipo_id" class="block text-sm font-medium text-gray-700 mb-1">
                Tipo de ID *
              </label>
              <select
                id="tipo_id"
                name="tipo_id"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              >
                <option value="CC" selected={persona.tipo_id === 'CC'}>Cédula de Ciudadanía</option>
                <option value="TI" selected={persona.tipo_id === 'TI'}>Tarjeta de Identidad</option>
                <option value="RC" selected={persona.tipo_id === 'RC'}>Registro Civil</option>
                <option value="CE" selected={persona.tipo_id === 'CE'}>Cédula de Extranjería</option>
              </select>
            </div>

            <div>
              <label for="numero_id" class="block text-sm font-medium text-gray-700 mb-1">
                Número de Identificación *
              </label>
              <input
                type="text"
                id="numero_id"
                name="numero_id"
                value={persona.numero_id}
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label for="genero" class="block text-sm font-medium text-gray-700 mb-1">
                Género
              </label>
              <select
                id="genero"
                name="genero"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              >
                <option value="">Seleccionar...</option>
                <option value="Masculino" selected={persona.genero === 'Masculino'}>Masculino</option>
                <option value="Femenino" selected={persona.genero === 'Femenino'}>Femenino</option>
              </select>
            </div>

            <div>
              <label for="fecha_nacimiento" class="block text-sm font-medium text-gray-700 mb-1">
                Fecha de Nacimiento
              </label>
              <input
                type="date"
                id="fecha_nacimiento"
                name="fecha_nacimiento"
                value={fechaNacimientoFormatted}
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
            </div>
          </div>
        </div>

        <!-- Información de Contacto -->
        <div class="space-y-4">
          <h2 class="text-lg font-semibold text-gray-900 border-b border-gray-200 pb-2">
            Información de Contacto
          </h2>

          <div>
            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">
              Email *
            </label>
            <input
              type="email"
              id="email"
              name="email"
              value={persona.email}
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>

          <div>
            <label for="telefono" class="block text-sm font-medium text-gray-700 mb-1">
              Teléfono *
            </label>
            <input
              type="tel"
              id="telefono"
              name="telefono"
              value={persona.telefono}
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>

          <div>
            <label for="direccion" class="block text-sm font-medium text-gray-700 mb-1">
              Dirección
            </label>
            <textarea
              id="direccion"
              name="direccion"
              rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            >{persona.direccion || ''}</textarea>
          </div>

          <div>
            <label for="sede_id" class="block text-sm font-medium text-gray-700 mb-1">
              Sede
            </label>
            <select
              id="sede_id"
              name="sede_id"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            >
              <option value="">Sin sede asignada</option>
              {sedes.map((sede) => (
                <option 
                  value={sede.id} 
                  selected={persona.sedes?.id === sede.id}
                >
                  {sede.nombre_sede}
                </option>
              ))}
            </select>
          </div>

          <div>
            <label for="url_foto" class="block text-sm font-medium text-gray-700 mb-1">
              URL de Foto
            </label>
            <input
              type="url"
              id="url_foto"
              name="url_foto"
              value={persona.url_foto || ''}
              placeholder="https://ejemplo.com/foto.jpg"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            />
          </div>
        </div>
      </div>

      <!-- Botones de acción -->
      <div class="mt-8 flex justify-between items-center pt-6 border-t border-gray-200">
        <a
          href={`/personas/${persona.id}`}
          class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
        >
          <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
          </svg>
          Cancelar
        </a>
        
        <button
          type="submit"
          class="inline-flex items-center px-6 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
        >
          <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
          </svg>
          Guardar Cambios
        </button>
      </div>
    </form>
  </div>
</LayoutProtected>

